<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/content :: setContent(~{this :: content})}">
    <th:block th:fragment="content">

        <h1 class="mt-4">영화 상세 : [[${result.movieName}]]</h1>

        <div class="form-group">
            <label >Title</label>
            <input class="form-control" th:value="${result.movieName}" name="title" readonly>
        </div>
        <div class="form-group">
            <p>Image Location</p>
        </div>
        <div class="form-group">
            <label >Director</label>
            <input class="form-control" th:value="${result.director}" name="director" readonly>
        </div>
        <div class="form-group">
            <label >Running Time</label>
            <input class="form-control" th:value="${result.runningTime}" name="runningTime" readonly>
        </div>

        <a class="btn btn-warning" th:href="@{/movies/info(page=${pageRequestDTO.page})}">돌아가기</a>
        <button type="button" class="btn btn-light addReview">리뷰 작성</button>

        <div class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">리뷰 작성</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <input class="form-control" type="text" name="content" placeholder="Reply Text...">
                        </div>
                        <div class="form-group">
                            <input class="form-control" type="text" name="writer" placeholder="Replyer">
                            <input type="hidden" name="id">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger reviewRemove">Remove</button>
                        <button type="button" class="btn btn-warning reviewModify">Modify</button>
                        <button type="button" class="btn btn-primary reviewSave">Save changes</button>
                        <button type="button" class="btn btn-outline-secondary reviewClose" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="reviewList">

        </div>

        <script th:inline="javascript">

            $(document).ready(function(){
                var reviewList = $(".reviewList");
                var movieId = [[${result.id}]];
                var modal = $(".modal");

                $.getJSON("/reviews/"+movieId, function(arr){
                    console.log(arr);
                    // 리뷰 화면 재조정.
                    makeReviewPage(arr);
                });

                $(".reviewList").on("click", ".page-link", function(){

                    var page = $(this).data("page");

                    $.ajax({
                        url: "/reviews/"+movieId+"/?page="+page,
                        method: "GET",
                        contentType: "application/json; charset=utf-8",
                        dataType: 'json',
                        success: function(arr){
                            console.log(arr);
                            // 리뷰 화면 재조정.
                            makeReviewPage(arr);
                        }
                    });

                });

                // API GET 요청으로 Review를 가져오면 가져온 정보를 토대로 리뷰 화면 다시 조정.
                function makeReviewPage(arr) {
                    var data = arr["dtoList"];
                    var str = "";

                    $.each(data, function(idx, review){

                        str += "<div>";
                        str += "<h5>"+review.content+"</h5>";
                        str += "<h6>"+review.writer+"</h6>";
                        str += "<h6>"+review.grade+"</h6>";
                        str += "</div>";

                    });

                    str += "<ul class='pagination h-100 justify-content-left align-items-center'>";
                    if(arr.prev) {
                        str += "<li class='page-item'>";
                        str += "<a class='page-link' data-page='"+(arr.start - 1)+"' tabindex='-1'>PREVIOUS</a>"
                        str += "</li>";
                    }

                    for(var pageIndex = 0; pageIndex < arr.pageList.length; pageIndex++) {
                        str += "<li>";
                        str += "<a class='page-link' data-page='"+arr.pageList[pageIndex]+"'>"+arr.pageList[pageIndex]+"</a>";
                        str += "</li>";
                    }

                    if(arr.next) {
                        str += "<li class='page-item'>";
                        str += "<a class='page-link' data-page='"+(arr.end + 1)+"'>NEXT</a>"
                        str += "</li>";
                    }
                    str += "</ul>";

                    reviewList.html(str);
                }

                // 리뷰 추가 버튼 눌렀을 때!
                $(".addReview").on("click", function() {

                    modal.modal("show");

                    $('input[name="content"]').val('');
                    $('input[name="writer"]').val('');

                    $('.modal-footer .btn').hide(); // 버튼 다 가리고
                    $('.reviewSave, .reviewClose').show(); // 필요한 버튼만 보이게

                });

                // 리뷰 모달창에서 저장 버튼 누를때!
                $(".reviewSave").on("click", function() {

                    var data = {
                        movieId: movieId,
                        content: $('input[name="content"]').val(),
                        writer: $('input[name="writer"]').val()
                    }

                    $.ajax({
                        url: '/reviews/',
                        method: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(data),
                        dataType: 'json',
                        success: function(result){
                            console.log(result);
                            var newId = parseInt(result);
                            alert(newId + "번 리뷰가 등록되었습니다!");
                            self.location.reload();
                        }
                    })

                });

            });

        </script>

    </th:block>
</th:block>

</html>